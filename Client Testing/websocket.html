<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Test - MoviesMe</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .subtitle {
        opacity: 0.9;
        font-size: 14px;
      }

      .controls {
        padding: 20px 30px;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      label {
        font-weight: 600;
        color: #495057;
      }

      input[type='text'] {
        padding: 10px 15px;
        border: 2px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        min-width: 250px;
        transition: border-color 0.3s;
      }

      input[type='text']:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        display: inline-block;
      }

      .status-connected {
        background: #d4edda;
        color: #155724;
      }

      .status-disconnected {
        background: #f8d7da;
        color: #721c24;
      }

      .events-container {
        padding: 20px 30px;
        max-height: 600px;
        overflow-y: auto;
      }

      .events-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
      }

      .events-title {
        font-size: 18px;
        font-weight: 600;
        color: #212529;
      }

      .clear-btn {
        padding: 6px 12px;
        background: #dc3545;
        font-size: 12px;
      }

      .clear-btn:hover {
        background: #c82333;
      }

      #events {
        list-style-type: none;
      }

      .event-item {
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid;
        background: #f8f9fa;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .event-item.connect {
        border-left-color: #28a745;
        background: #d4edda;
      }
      .event-item.disconnect {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .event-item.error {
        border-left-color: #dc3545;
        background: #f8d7da;
      }
      .event-item.success {
        border-left-color: #28a745;
        background: #d4edda;
      }
      .event-item.info {
        border-left-color: #17a2b8;
        background: #d1ecf1;
      }
      .event-item.progress {
        border-left-color: #ffc107;
        background: #fff3cd;
      }
      .event-item.completed {
        border-left-color: #28a745;
        background: #d4edda;
      }

      .event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .event-name {
        font-weight: 700;
        font-size: 14px;
        color: #212529;
      }

      .event-time {
        font-size: 11px;
        color: #6c757d;
      }

      .event-data {
        background: white;
        padding: 10px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .stats {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
      }

      .stat-item {
        flex: 1;
        text-align: center;
        padding: 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      .stat-label {
        font-size: 11px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
      }

      .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: #667eea;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸŽ¬ WebSocket Test Client</h1>
        <div class="subtitle">
          Real-time connection testing for MoviesMe Server
        </div>
      </header>

      <div class="controls">
        <div class="control-group">
          <label for="userId">User ID:</label>
          <input
            type="text"
            id="userId"
            value="68dc6b7e0dfbb81d538692ab"
            placeholder="Enter user ID"
          />
          <button id="joinRoom">ðŸ”— Join Room</button>
          <button id="healthCheck">ðŸ’š Health Check</button>
          <button id="pingServer">ðŸ“¡ Ping Server</button>
          <span id="connectionStatus" class="status-badge status-disconnected"
            >Disconnected</span
          >
        </div>

        <div class="stats">
          <div class="stat-item">
            <div class="stat-label">Total Events</div>
            <div class="stat-value" id="totalEvents">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Socket ID</div>
            <div class="stat-value" id="socketId" style="font-size: 12px">
              -
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Transport</div>
            <div class="stat-value" id="transport" style="font-size: 14px">
              -
            </div>
          </div>
        </div>
      </div>

      <div class="events-container">
        <div class="events-header">
          <div class="events-title">ðŸ“‹ Event Log</div>
          <button class="clear-btn" id="clearEvents">Clear Log</button>
        </div>
        <ul id="events"></ul>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io('http://localhost:3000', {
        transports: ['polling', 'websocket'],
        upgrade: true,
      });

      const connectionStatus = document.getElementById('connectionStatus');
      const eventsList = document.getElementById('events');
      const userIdInput = document.getElementById('userId');
      const joinRoomButton = document.getElementById('joinRoom');
      const healthCheckButton = document.getElementById('healthCheck');
      const pingServerButton = document.getElementById('pingServer');
      const clearEventsButton = document.getElementById('clearEvents');
      const totalEventsEl = document.getElementById('totalEvents');
      const socketIdEl = document.getElementById('socketId');
      const transportEl = document.getElementById('transport');

      let eventCount = 0;

      // Connection event
      socket.on('connect', () => {
        connectionStatus.textContent = `Connected: ${socket.id}`;
        connectionStatus.className = 'status-badge status-connected';
        socketIdEl.textContent = socket.id.substring(0, 8) + '...';
        addEventToList(
          'connect',
          { message: 'Connected to server', socketId: socket.id },
          'connect'
        );

        // Update transport info
        updateTransportInfo();
      });

      // Disconnect event
      socket.on('disconnect', (reason) => {
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.className = 'status-badge status-disconnected';
        socketIdEl.textContent = '-';
        transportEl.textContent = '-';
        addEventToList(
          'disconnect',
          { reason, message: 'Disconnected from server' },
          'disconnect'
        );
      });

      // Connection confirmed event
      socket.on('connection:confirmed', (data) => {
        addEventToList('connection:confirmed', data, 'success');
      });

      // Socket error
      socket.on('socket:error', (data) => {
        addEventToList('socket:error', data, 'error');
      });

      // Connect error
      socket.on('connect_error', (error) => {
        addEventToList('connect_error', { error: error.message }, 'error');
      });

      // Pong response
      socket.on('pong', (data) => {
        const latency = Date.now() - data.timestamp;
        addEventToList('pong', { ...data, latency: `${latency}ms` }, 'info');
        updateTransportInfo();
      });

      // Health response
      socket.on('health:response', (data) => {
        addEventToList('health:response', data, 'success');
        updateTransportInfo();
      });

      // Job events
      socket.on('job:progress', (data) => {
        addEventToList('job:progress', data, 'progress');
      });

      socket.on('job:completed', (data) => {
        addEventToList('job:completed', data, 'completed');
      });

      // Story events
      socket.on('story:progress', (data) => {
        addEventToList('story:progress', data, 'progress');
      });

      socket.on('story:completed', (data) => {
        addEventToList('story:completed', data, 'completed');
      });

      // Generation library events
      socket.on('generationLib:progress', (data) => {
        addEventToList('generationLib:progress', data, 'progress');
      });

      socket.on('generationLib:completed', (data) => {
        addEventToList('generationLib:completed', data, 'completed');
      });

      // Transport upgrade
      socket.io.engine.on('upgrade', () => {
        updateTransportInfo();
        addEventToList(
          'upgrade',
          { message: 'Transport upgraded to WebSocket' },
          'success'
        );
      });

      // Button event listeners
      joinRoomButton.addEventListener('click', () => {
        const userId = userIdInput.value.trim();
        if (userId) {
          socket.emit('join:user', userId);
          addEventToList(
            'join:user [SENT]',
            { userId, room: `user:${userId}` },
            'info'
          );
        } else {
          alert('Please enter a User ID');
        }
      });

      healthCheckButton.addEventListener('click', () => {
        socket.emit('health:check');
        addEventToList(
          'health:check [SENT]',
          { message: 'Requesting health check' },
          'info'
        );
      });

      pingServerButton.addEventListener('click', () => {
        socket.emit('ping', { timestamp: Date.now() });
        addEventToList('ping [SENT]', { message: 'Pinging server' }, 'info');
      });

      clearEventsButton.addEventListener('click', () => {
        eventsList.innerHTML = '';
        eventCount = 0;
        totalEventsEl.textContent = '0';
      });

      // Helper functions
      function updateTransportInfo() {
        if (socket.io && socket.io.engine) {
          transportEl.textContent =
            socket.io.engine.transport.name.toUpperCase();
        }
      }

      function addEventToList(eventName, data, type = 'info') {
        eventCount++;
        totalEventsEl.textContent = eventCount;

        const li = document.createElement('li');
        li.className = `event-item ${type}`;

        const eventHeader = document.createElement('div');
        eventHeader.className = 'event-header';

        const eventNameSpan = document.createElement('span');
        eventNameSpan.className = 'event-name';
        eventNameSpan.textContent = eventName;

        const eventTime = document.createElement('span');
        eventTime.className = 'event-time';
        eventTime.textContent = new Date().toLocaleTimeString();

        eventHeader.appendChild(eventNameSpan);
        eventHeader.appendChild(eventTime);

        const eventData = document.createElement('div');
        eventData.className = 'event-data';
        eventData.textContent = JSON.stringify(data, null, 2);

        li.appendChild(eventHeader);
        li.appendChild(eventData);
        eventsList.insertBefore(li, eventsList.firstChild);

        // Keep only last 50 events
        while (eventsList.children.length > 50) {
          eventsList.removeChild(eventsList.lastChild);
        }
      }

      // Auto-join on page load if user ID is set
      window.addEventListener('load', () => {
        const userId = userIdInput.value.trim();
        if (userId && socket.connected) {
          setTimeout(() => {
            socket.emit('join:user', userId);
            addEventToList(
              'join:user [AUTO]',
              { userId, room: `user:${userId}` },
              'info'
            );
          }, 500);
        }
      });
    </script>
  </body>
</html>
