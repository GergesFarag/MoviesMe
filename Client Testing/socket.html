<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Socket.io Test Client — User-Only Job Updates</title>
    <style>
      :root {
        --bg: #0f172a; /* slate-900 */
        --panel: #111827; /* gray-900 */
        --accent: #22c55e; /* green-500 */
        --accent-2: #60a5fa; /* blue-400 */
        --text: #e5e7eb; /* gray-200 */
        --muted: #94a3b8; /* slate-400 */
        --danger: #ef4444; /* red-500 */
        --warn: #f59e0b; /* amber-500 */
        --ok: #10b981; /* emerald-500 */
        --chip: #1f2937; /* gray-800 */
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0b1022, var(--bg));
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji";
        display: grid;
        place-items: center;
        padding: 24px;
      }
      .app {
        width: min(1100px, 100%);
        display: grid;
        gap: 16px;
      }
      .card {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 16px;
        backdrop-filter: blur(6px);
      }
      .row {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr 1fr 1fr;
        padding: 16px;
      }
      .row.small {
        grid-template-columns: 1fr 1fr;
      }
      .row .field {
        display: grid;
        gap: 8px;
      }
      label {
        font-size: 12px;
        color: var(--muted);
      }
      input[type="text"],
      input[type="password"] {
        background: #0b1220;
        border: 1px solid #1e293b;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        outline: none;
        font-size: 14px;
      }
      input::placeholder {
        color: #64748b;
      }
      .actions {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 0 16px 16px;
        flex-wrap: wrap;
      }
      button {
        background: var(--chip);
        color: var(--text);
        border: 1px solid #293043;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.2px;
        transition: all 0.15s ease;
      }
      button.primary {
        background: var(--accent);
        border-color: #16a34a;
        color: #052e16;
      }
      button.secondary {
        background: var(--accent-2);
        border-color: #3b82f6;
        color: #04142b;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .statusbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-top: 1px solid rgba(148, 163, 184, 0.15);
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--chip);
        border: 1px solid #293043;
        color: var(--muted);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--muted);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.04) inset;
      }
      .dot.ok {
        background: var(--ok);
      }
      .dot.warn {
        background: var(--warn);
      }
      .dot.err {
        background: var(--danger);
      }

      .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .filters label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--chip);
        border: 1px solid #293043;
        color: var(--text);
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
      }

      .log {
        padding: 0;
        margin: 0;
        list-style: none;
        max-height: 52vh;
        overflow: auto;
      }
      .log-item {
        border-top: 1px solid rgba(148, 163, 184, 0.12);
        padding: 12px 16px;
        display: grid;
        gap: 8px;
      }
      .evhead {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .evname {
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      .evtime {
        font-size: 12px;
        color: var(--muted);
      }
      pre {
        margin: 0;
        background: #0b1220;
        border: 1px dashed #1e293b;
        padding: 10px;
        border-radius: 10px;
        font-size: 12px;
        overflow: auto;
      }

      .footer {
        text-align: center;
        color: var(--muted);
        font-size: 12px;
        padding: 8px;
      }
      .hl-ok {
        color: var(--ok);
        font-weight: 700;
      }
      .hl-warn {
        color: var(--warn);
        font-weight: 700;
      }
      .hl-err {
        color: var(--danger);
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <div class="row">
          <div class="field">
            <label>API Base URL</label>
            <input
              id="apiUrl"
              type="text"
              placeholder="http://localhost:3000"
              value="http://localhost:3000"
            />
          </div>
          <div class="field">
            <label>User ID</label>
            <input id="userId" type="text" placeholder="e.g., 66cf1b8a3c..." />
          </div>
          <div class="field">
            <label>Auth Token (optional, sent in auth)</label>
            <input
              id="authToken"
              type="password"
              placeholder="JWT or any token your server expects"
            />
          </div>
        </div>
        <div class="actions">
          <button id="connectBtn" class="primary">
            Connect & Join User Room
          </button>
          <button id="disconnectBtn">Disconnect</button>
          <button id="clearBtn">Clear Log</button>
          <button id="copyBtn" class="secondary">Copy Log JSON</button>
        </div>
        <div class="statusbar">
          <div class="chip">
            <span id="statusDot" class="dot"></span
            ><span id="statusText">Disconnected</span>
          </div>
          <div class="filters">
            <label
              ><input type="checkbox" class="flt" value="job:queued" checked />
              queued</label
            >
            <label
              ><input type="checkbox" class="flt" value="job:active" checked />
              active</label
            >
            <label
              ><input
                type="checkbox"
                class="flt"
                value="job:progress"
                checked
              />
              progress</label
            >
            <label
              ><input
                type="checkbox"
                class="flt"
                value="job:completed"
                checked
              />
              completed</label
            >
            <label
              ><input type="checkbox" class="flt" value="job:failed" checked />
              failed</label
            >
            <label
              ><input
                type="checkbox"
                class="flt"
                value="connect_error"
                checked
              />
              connect_error</label
            >
            <label
              ><input type="checkbox" class="flt" value="disconnect" checked />
              disconnect</label
            >
          </div>
        </div>
        <ul id="log" class="log"></ul>
      </div>
      <div class="footer">
        Socket.io Test Client — emits <code>join:user</code> and listens only to
        your jobs.
      </div>
    </div>

   <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const $ = (id) => document.getElementById(id);
      const apiUrlEl = $("apiUrl");
      const userIdEl = $("userId");
      const authTokenEl = $("authToken");
      const connectBtn = $("connectBtn");
      const disconnectBtn = $("disconnectBtn");
      const clearBtn = $("clearBtn");
      const copyBtn = $("copyBtn");
      const logEl = $("log");
      const statusDot = $("statusDot");
      const statusText = $("statusText");

      let socket = null;
      let allLogs = [];

      const wanted = () =>
        new Set(
          Array.from(document.querySelectorAll(".flt:checked")).map(
            (c) => c.value
          )
        );

      function setStatus(kind, text) {
        statusDot.className = "dot";
        if (kind === "ok") statusDot.classList.add("ok");
        if (kind === "warn") statusDot.classList.add("warn");
        if (kind === "err") statusDot.classList.add("err");
        statusText.textContent = text;
      }

      function now() {
        return new Date().toLocaleString();
      }

      function addLog(event, payload) {
        const entry = { time: new Date().toISOString(), event, payload };
        allLogs.push(entry);

        if (!wanted().has(event)) return; // hidden by filter

        const li = document.createElement("li");
        li.className = "log-item";
        const head = document.createElement("div");
        head.className = "evhead";
        const name = document.createElement("div");
        name.className = "evname";

        let colorClass = "";
        if (event.includes("completed")) colorClass = "hl-ok";
        else if (event.includes("failed") || event.includes("connect_error"))
          colorClass = "hl-err";
        else if (event.includes("active") || event.includes("progress"))
          colorClass = "hl-warn";

        name.innerHTML = `<span class="${colorClass}">${event}</span>`;

        const t = document.createElement("div");
        t.className = "evtime";
        t.textContent = now();
        head.appendChild(name);
        head.appendChild(t);

        const pre = document.createElement("pre");
        pre.textContent = JSON.stringify(payload, null, 2);

        li.appendChild(head);
        li.appendChild(pre);
        logEl.prepend(li);
      }

      function clearLog() {
        allLogs = [];
        logEl.innerHTML = "";
      }

      function copyLog() {
        const text = JSON.stringify(allLogs, null, 2);
        navigator.clipboard.writeText(text).then(() => {
          addLog("client:info", { message: "Copied log JSON to clipboard" });
        });
      }

      function connect() {
        const url = apiUrlEl.value.trim() || "http://localhost:3000";
        const userId = userIdEl.value.trim();
        const token = authTokenEl.value.trim();

        if (!userId) {
          alert("Please enter a User ID first.");
          return;
        }

        if (socket) {
          try {
            socket.disconnect();
          } catch {}
          socket = null;
        }

        // Build options with fallback transports
        const opts = { 
          transports: ["websocket", "polling"],
          timeout: 20000,
          forceNew: true,
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionAttempts: 5,
          maxReconnectionAttempts: 5
        };
        if (token) opts.auth = { token };

        addLog("client:info", { message: "Attempting to connect...", url });
        setStatus("warn", "Connecting...");

        socket = io(url, opts);

        socket.on("connect", () => {
          setStatus("ok", `Connected: ${socket.id}`);
          addLog("connect", { id: socket.id, url, transport: socket.io.engine.transport.name });
          socket.emit("join:user", userId);
          addLog("client:join", { room: `user:${userId}` });
        });

        socket.on("connect_error", (err) => {
          setStatus("err", "Connect error");
          addLog("connect_error", { 
            message: err?.message || "Unknown connection error", 
            data: err?.data,
            type: err?.type,
            description: err?.description
          });
        });

        socket.on("disconnect", (reason) => {
          setStatus("warn", `Disconnected: ${reason}`);
          addLog("disconnect", { reason });
          
          // Attempt reconnection for certain disconnect reasons
          if (reason === "io server disconnect") {
            addLog("client:info", { message: "Server disconnected. Attempting to reconnect..." });
          }
        });

        socket.on("reconnect", (attemptNumber) => {
          addLog("reconnect", { attemptNumber });
          setStatus("ok", `Reconnected after ${attemptNumber} attempts`);
        });

        socket.on("reconnect_attempt", (attemptNumber) => {
          addLog("reconnect_attempt", { attemptNumber });
          setStatus("warn", `Reconnecting... (${attemptNumber})`);
        });

        socket.on("reconnect_error", (error) => {
          addLog("reconnect_error", { message: error?.message });
        });

        socket.on("reconnect_failed", () => {
          addLog("reconnect_failed", { message: "Failed to reconnect" });
          setStatus("err", "Reconnection failed");
        });

        // Listen to server events for this user
        [
          "story:progress",
          "story:completed",
          "story:failed"
        ].forEach((ev) => socket.on(ev, (payload) => addLog(ev, payload)));

        // Add heartbeat
        setInterval(() => {
          if (socket && socket.connected) {
            socket.emit("ping");
          }
        }, 25000);
      }

      function disconnect() {
        if (!socket) return;
        try {
          socket.disconnect();
        } finally {
          socket = null;
          setStatus("warn", "Disconnected");
        }
      }

      // Wire buttons
      connectBtn.addEventListener("click", connect);
      disconnectBtn.addEventListener("click", disconnect);
      clearBtn.addEventListener("click", clearLog);
      copyBtn.addEventListener("click", copyLog);
    </script>
  </body>
</html>
