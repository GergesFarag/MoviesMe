<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Transport Close Debugger</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .panel { background: #2a2a2a; padding: 20px; margin: 10px 0; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        button.danger { background: #f44336; }
        button.warning { background: #ff9800; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #555; background: #333; color: #fff; border-radius: 4px; }
        .log { background: #000; color: #0f0; padding: 15px; height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .stat-item { background: #333; padding: 15px; border-radius: 4px; text-align: center; }
        .status { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status.connected { background: #4CAF50; }
        .status.disconnected { background: #f44336; }
        .status.connecting { background: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç WebSocket Transport Close Debugger</h1>
        
        <div class="panel">
            <h3>Connection Settings</h3>
            <input type="text" id="serverUrl" placeholder="Server URL" value="http://localhost:3000">
            <input type="text" id="userId" placeholder="User ID" value="test-user-123">
            <select id="transportMode">
                <option value="auto">Auto (polling ‚Üí websocket)</option>
                <option value="polling">Polling Only</option>
                <option value="websocket">WebSocket Only</option>
                <option value="websocket-first">WebSocket First</option>
            </select>
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()" class="danger">Disconnect</button>
            <span class="status disconnected" id="status"></span>
            <span id="statusText">Disconnected</span>
        </div>

        <div class="panel">
            <h3>Test Scenarios</h3>
            <button onclick="testHealthCheck()">Health Check</button>
            <button onclick="testStatsRequest()">Get Stats</button>
            <button onclick="testSmallMessages()">Small Messages</button>
            <button onclick="testLargeMessages()" class="warning">Large Messages</button>
            <button onclick="testRapidMessages()" class="warning">Rapid Messages</button>
            <button onclick="triggerStoryProgress()">Story Progress</button>
            <button onclick="printServerStats()">Print Server Stats</button>
        </div>

        <div class="panel">
            <h3>Connection Statistics</h3>
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div>Transport Closes</div>
                    <div id="transportCloses">0</div>
                </div>
                <div class="stat-item">
                    <div>Total Disconnects</div>
                    <div id="totalDisconnects">0</div>
                </div>
                <div class="stat-item">
                    <div>Current Transport</div>
                    <div id="currentTransport">None</div>
                </div>
                <div class="stat-item">
                    <div>Connection Duration</div>
                    <div id="connectionDuration">0s</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>Live Log</h3>
            <button onclick="clearLog()">Clear Log</button>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let connectTime = null;
        let stats = {
            transportCloses: 0,
            totalDisconnects: 0
        };

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'success': '#0f0'
            }[type] || '#0f0';
            
            logEl.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(status, text) {
            const statusEl = document.getElementById('status');
            const statusTextEl = document.getElementById('statusText');
            
            statusEl.className = `status ${status}`;
            statusTextEl.textContent = text;
        }

        function updateStats() {
            document.getElementById('transportCloses').textContent = stats.transportCloses;
            document.getElementById('totalDisconnects').textContent = stats.totalDisconnects;
            
            if (socket) {
                document.getElementById('currentTransport').textContent = 
                    socket.io?.engine?.transport?.name || 'Unknown';
                
                if (connectTime) {
                    const duration = Math.round((Date.now() - connectTime) / 1000);
                    document.getElementById('connectionDuration').textContent = duration + 's';
                }
            } else {
                document.getElementById('currentTransport').textContent = 'None';
                document.getElementById('connectionDuration').textContent = '0s';
            }
        }

        function connect() {
            if (socket) {
                socket.disconnect();
            }

            const serverUrl = document.getElementById('serverUrl').value;
            const userId = document.getElementById('userId').value;
            const transportMode = document.getElementById('transportMode').value;

            let transports;
            switch (transportMode) {
                case 'polling':
                    transports = ['polling'];
                    break;
                case 'websocket':
                    transports = ['websocket'];
                    break;
                case 'websocket-first':
                    transports = ['websocket', 'polling'];
                    break;
                default:
                    transports = ['polling', 'websocket'];
            }

            const options = {
                transports: transports,
                pingInterval: 60000,
                pingTimeout: 120000,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 2000
            };

            log(`Connecting to ${serverUrl} with transports: ${transports.join(', ')}`);
            updateStatus('connecting', 'Connecting...');

            socket = io(serverUrl, options);

            socket.on('connect', () => {
                connectTime = Date.now();
                const transport = socket.io.engine.transport.name;
                log(`‚úÖ Connected with transport: ${transport}`, 'success');
                updateStatus('connected', 'Connected');
                
                socket.emit('join:user', userId);
                log(`üîó Joined user room: ${userId}`);
                updateStats();
            });

            socket.on('disconnect', (reason) => {
                stats.totalDisconnects++;
                if (reason === 'transport close') {
                    stats.transportCloses++;
                }
                
                log(`‚ùå Disconnected: ${reason}`, 'error');
                updateStatus('disconnected', `Disconnected: ${reason}`);
                connectTime = null;
                updateStats();
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                updateStatus('disconnected', 'Connection Error');
            });

            socket.io.engine.on('upgrade', () => {
                const transport = socket.io.engine.transport.name;
                log(`‚¨ÜÔ∏è Upgraded to: ${transport}`, 'success');
                updateStats();
            });

            socket.io.engine.on('upgradeError', (error) => {
                log(`‚ùå Upgrade failed: ${error.message}`, 'error');
            });

            socket.on('health:response', (data) => {
                log(`üíö Health: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('stats:response', (data) => {
                log(`üìä Server Stats: ${JSON.stringify(data, null, 2)}`, 'info');
            });

            socket.on('story:progress', (data) => {
                log(`üìà Story Progress: ${data.progress}% - ${data.status}`, 'info');
            });

            // Update stats every second
            setInterval(updateStats, 1000);
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
                connectTime = null;
                updateStats();
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testHealthCheck() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            log('üîç Requesting health check...');
            socket.emit('health:check');
        }

        function testStatsRequest() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            log('üìä Requesting server stats...');
            socket.emit('stats:request');
        }

        function testSmallMessages() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            log('üì® Sending small messages...');
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    socket.emit('ping', { test: i, data: 'small' });
                }, i * 100);
            }
        }

        function testLargeMessages() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            log('üì® Sending large messages...', 'warn');
            const largeData = 'x'.repeat(50000); // 50KB
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    socket.emit('ping', { test: i, data: largeData });
                    log(`üì¶ Sent large message ${i + 1}/3`);
                }, i * 1000);
            }
        }

        function testRapidMessages() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            log('‚ö° Sending rapid messages...', 'warn');
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    socket.emit('ping', { test: i, rapid: true });
                }, i * 20); // Every 20ms
            }
        }

        function triggerStoryProgress() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            log('üé¨ Simulating story progress...');
            
            // Simulate story progress messages
            for (let i = 0; i <= 100; i += 10) {
                setTimeout(() => {
                    socket.emit('story:progress', {
                        progress: i,
                        status: `Processing step ${i}%`,
                        jobId: 'test-job-123'
                    });
                }, i * 100);
            }
        }

        function printServerStats() {
            if (!socket || !socket.connected) {
                log('‚ùå Not connected', 'error');
                return;
            }
            log('üñ®Ô∏è Requesting server to print stats to console...');
            socket.emit('debug:summary');
        }

        // Initialize
        updateStatus('disconnected', 'Disconnected');
        updateStats();
    </script>
</body>
</html>